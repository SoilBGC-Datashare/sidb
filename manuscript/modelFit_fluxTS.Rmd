---
title: "Untitled"
author: "Mina Azizi-Rad"
date: "7/9/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error = TRUE)
packs <- c('SoilR', 'sidb', 'R.utils', 'dplyr')
sapply(packs, require, character.only=TRUE)
rm(list=ls())

```



```{r sidb database, results='hide'}
db=loadEntries(path="~/sidb/data/")
db_flat=flatterSIDb(db)
```



```{r }
FitModel<- function(db, ts.col, ic.col, UnitConverter,
                          inipars= list(c(0.01, 0.001, 0.1),
                                        c(5e-03, 1e-05, 0.1, 0.01, 0.01), 
                                        c(5e-03, 1e-05, 0.1, 0.01))){
  mod0 <- onepFitFlux(timeSeries = db$timeSeries[, c(1,ts.col)], initialCarbon = db$initConditions[ic.col, 'carbonMean']*UnitConverter)
  mod1 <- twoppFit(timeSeries = db$timeSeries[, c(1,ts.col)], initialCarbon = db$initConditions[ic.col, 'carbonMean']*UnitConverter, 
                     inipars = inipars[[1]])
  mod2 <- twopfFit(timeSeries = db$timeSeries[, c(1,ts.col)], initialCarbon = db$initConditions[ic.col, 'carbonMean']*UnitConverter, 
                   inipars = inipars[[2]])
  mod3 <- twopsFit(timeSeries = db$timeSeries[, c(1,ts.col)], initialCarbon = db$initConditions[ic.col, 'carbonMean']*UnitConverter, 
                   inipars = inipars[[3]])
  
  days= mod1$SoilRmodel@times
  Mlist=list(mod0, mod1, mod2, mod3)
  modelNames=c("One-pool","Two-pool parallel" ,"Two-pool feedback", "Two-pool series")
  Rt=lapply(Mlist, function(x){getReleaseFlux(x$SoilRmodel)})
  
  par(mfrow=c(2,2))
  for (i in c(1:4)){
    matplot(days, Rt[[i]], type="l", lty=1, ylab=db$variables$V2$units, xlab="Day", 
    main=modelNames[i])
    points(db$timeSeries[, c(1,ts.col)], pch=19, cex=0.5)}
  par(mfrow=c(1,1))
  
  #Calculating the AIC 
  AIC=sapply(Mlist, function(x){AIC=x$AIC})
  K=sapply(Mlist, function(x){length(x$FMEmodel$par)})
  n=nrow(db$timeSeries[, c(1,ts.col)])
    
  AICc=list(NULL)
  for(i in 1:length(Mlist)){
    AICc[[i]]=AIC[[i]]+( (2*K[[i]]*(K[[i]]+1))/(n-K[[i]]-1))
  }
  AICmin=min(unlist(AICc))
  
  delta_i=list(NULL)
  for(i in 1:length(AICc)){
    delta_i[[i]]=AICc[[i]]-AICmin
  }
  
  wi=list(NULL)
  for(i in 1:length(delta_i)){
    wi[[i]]=exp(-0.5 * delta_i[[i]])/(exp(-0.5* delta_i[[1]]) + exp(-0.5*delta_i[[2]]) + exp(-0.5*delta_i[[3]]) )
  }
  # Transit time based on each model
  a1=mod1$SoilRmodel@mat@map() ;gam=mod1$SoilRmodel@initialValues #vector of initial values in each pool
  tt1= transitTime(A = a1, u =gam, q = 0.5, a = 0)

  a2=mod2$SoilRmodel@mat@map()
  tt2=transitTime(A = a2, u =c(1, 0), q = 0.5, a = 0)

  a3=mod3$SoilRmodel@mat@map()
  tt3=transitTime(A = a3, u =c(1, 0), q = 0.5, a = 0)
  
  TT=c(NA, tt1$meanTransitTime, tt2$meanTransitTime, tt3$meanTransitTime)
  q05=c(NA, tt1$quantiles, tt2$quantiles, tt3$quantiles)
  
  # Model parameters to be collected in the table
  k1=sapply(Mlist, function(x){x$FMEmodel$par[1]})
  k2=sapply(Mlist, function(x){x$FMEmodel$par[2]})

  pC0= c(NA, mod1$FMEmodel$par[3], mod2$FMEmodel$par[5], mod3$FMEmodel$par[4])
  a21=c(NA, NA, mod2$FMEmodel$par[3], mod3$FMEmodel$par[3])
  a12=c(NA, NA, mod2$FMEmodel$par[4], NA)
  
  tbldb <- data.frame(model=modelNames, AIC=AIC, k1=k1, k2=k2, C0Inp1=pC0, a21=a21, a12=a12, AICc= unlist(AICc), wi=unlist(wi), MeanTrT=TT, q05=q05 )
  
  #Collect all the results in a table
  tbldb %>% dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>%
    knitr::kable(.)
}
```


\newpage

# Dataset `r db[[4]]$citationKey` 

This is the results of a depth-warming experiment with two levels of Control and warming. The dataset has 9 column of time, three depth on each warming and control. The variables V3, V5, V7, V9, V11 and V15 are the sd. 

initial carbon unit is `r db[[4]]$initConditions[1, "carbonUnits"]`

Variable 2: `r db[[4]]$variables$V2$varDesc`
```{r}
FitModel(db = db[[4]], ts.col = 2, ic.col = 1, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

Variable 4: `r db[[4]]$variables$V4$varDesc`
```{r}
FitModel(db = db[[4]], ts.col = 4, ic.col = 2, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

Variable 6: `r db[[4]]$variables$V6$varDesc`
```{r}
db[[4]]$variables$V6$fieldWarming ;db[[4]]$variables$V6$midDepth;
FitModel(db = db[[4]], ts.col = 6, ic.col = 3, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

Variable 8: `r db[[4]]$variables$V8$varDesc`
```{r}
FitModel(db = db[[4]], ts.col = 8, ic.col = 4, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

Variable 10: `r db[[4]]$variables$V10$varDesc`
```{r}
FitModel(db = db[[4]], ts.col = 10, ic.col = 5, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

Variable 12: `r db[[4]]$variables$V12$varDesc`
```{r}
FitModel(db = db[[4]], ts.col = 12, ic.col = 6, UnitConverter = 1e4,
         inipars= list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)))
```

\newpage
# Dataset `r db[[19]]$citationKey` 

A dataset with 14 variables and 6 different soil types of `r db_flat$vars$NeffHooper2002[1, "incDesc"] `. 

Share key between variables and initial carbon is the site and vegetation. 
```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[2, 'site']), as.character(db[[19]]$variables$V2$site))
identical(as.character(db[[19]]$initConditions[2, 'vegetation']), as.character(db[[19]]$variables$V2$vegetation))

```
Variable 2: `r db[[19]]$variables$V2$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 2, ic.col = 2, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.05, 0.00001, 0.1, 0.01, 0.01),
                       c(0.005, 1e-05, 0.1, 0.01)) )
```

```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[3, 'site']), as.character(db[[19]]$variables$V3$site))
identical(as.character(db[[19]]$initConditions[3, 'vegetation']), as.character(db[[19]]$variables$V3$vegetation))

```
Variable 3: `r db[[19]]$variables$V3$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 3, ic.col = 3, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[4, 'site']), as.character(db[[19]]$variables$V4$site))
identical(as.character(db[[19]]$initConditions[4, 'vegetation']), as.character(db[[19]]$variables$V4$vegetation))

```

Variable 4: `r db[[19]]$variables$V4$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 4, ic.col = 4, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[7, 'site']), as.character(db[[19]]$variables$V5$site))
identical(as.character(db[[19]]$initConditions[7, 'vegetation']), as.character(db[[19]]$variables$V5$vegetation))

```

Variable 5: `r db[[19]]$variables$V5$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 5, ic.col = 7, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[2, 'site']), as.character(db[[19]]$variables$V6$site))
identical(as.character(db[[19]]$initConditions[2, 'vegetation']), as.character(db[[19]]$variables$V6$vegetation))

```

Variable 6: `r db[[19]]$variables$V6$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 6, ic.col = 2, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[3, 'site']), as.character(db[[19]]$variables$V7$site))
identical(as.character(db[[19]]$initConditions[3, 'vegetation']), as.character(db[[19]]$variables$V7$vegetation))

```

Variable 7: `r db[[19]]$variables$V7$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 7, ic.col = 3, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[4, 'site']), as.character(db[[19]]$variables$V8$site))
identical(as.character(db[[19]]$initConditions[4, 'vegetation']), as.character(db[[19]]$variables$V8$vegetation))

```
Variable 8: `r db[[19]]$variables$V8$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 8, ic.col = 4, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[7, 'site']), as.character(db[[19]]$variables$V9$site))
identical(as.character(db[[19]]$initConditions[7, 'vegetation']), as.character(db[[19]]$variables$V9$vegetation))

```

Variable 9: `r db[[19]]$variables$V9$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 9, ic.col = 7, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[2, 'site']), as.character(db[[19]]$variables$V10$site))
identical(as.character(db[[19]]$initConditions[2, 'vegetation']), as.character(db[[19]]$variables$V10$vegetation))

```

Variable 10: `r db[[19]]$variables$V10$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 10, ic.col = 2, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[1, 'site']), as.character(db[[19]]$variables$V11$site))
identical(as.character(db[[19]]$initConditions[1, 'vegetation']), as.character(db[[19]]$variables$V11$vegetation))

```

Variable 11: `r db[[19]]$variables$V11$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 11, ic.col = 1, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```


```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[4, 'site']), as.character(db[[19]]$variables$V12$site))
identical(as.character(db[[19]]$initConditions[4, 'vegetation']), as.character(db[[19]]$variables$V12$vegetation))

```

Variable 12: `r db[[19]]$variables$V12$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 12, ic.col = 4, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```



```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[6, 'site']), as.character(db[[19]]$variables$V13$site))
identical(as.character(db[[19]]$initConditions[6, 'vegetation']), as.character(db[[19]]$variables$V13$vegetation))

```

Variable 13: `r db[[19]]$variables$V13$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 13, ic.col = 6, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```



```{r, results='hide'}
identical(as.character(db[[19]]$initConditions[5, 'site']), as.character(db[[19]]$variables$V14$site))
identical(as.character(db[[19]]$initConditions[5, 'vegetation']), as.character(db[[19]]$variables$V14$vegetation))

```

Variable 14: `r db[[19]]$variables$V14$varDesc`
```{r}
FitModel(db = db[[19]], ts.col = 14, ic.col = 5, UnitConverter = 10,
         inipars =list(c(0.01, 0.001, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 1e-05, 0.1, 0.01)) )
```

\newpage

# Dataset `r db[[30]]$citationKey` 

Measuring mean rate of $CO_2$ evolution for A , E and B horizons at 38, 22, 15 and 4 $^\circ C$

initial carbon unit is `r db[[30]]$initConditions[1, "carbonUnits"]` and the fluxs are reported as `r db[[30]]$variables$V2$unit`


Variable 2: `r db[[30]]$variables$V2$varDesc`
```{r}
db[[30]]$variables$V2$midDepth
FitModel(db = db[[30]], ts.col = 2, ic.col = 1, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V3$midDepth
FitModel(db = db[[30]], ts.col = 3, ic.col = 3, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V4$midDepth
FitModel(db = db[[30]], ts.col = 4, ic.col = 2, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V5$midDepth
FitModel(db = db[[30]], ts.col = 5, ic.col = 1, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V6$midDepth
FitModel(db = db[[30]], ts.col = 6, ic.col = 3, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V7$midDepth
FitModel(db = db[[30]], ts.col = 7, ic.col = 2, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[30]]$variables$V8$midDepth
FitModel(db = db[[30]], ts.col = 8, ic.col = 1, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V9$midDepth
FitModel(db = db[[30]], ts.col = 9, ic.col = 3, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V10$midDepth
FitModel(db = db[[30]], ts.col = 10, ic.col = 2, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V11$midDepth
FitModel(db = db[[30]], ts.col = 11, ic.col = 1, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V12$midDepth
FitModel(db = db[[30]], ts.col = 12, ic.col = 3, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[30]]$variables$V13$midDepth
FitModel(db = db[[30]], ts.col = 13, ic.col = 2, UnitConverter = 1e4 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[31]]$citationKey

```


```{r}
db[[31]]$variables$V2$site
FitModel(db = db[[31]], ts.col = 2, ic.col = 1, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```


```{r}
db[[31]]$variables$V3$site
FitModel(db = db[[31]], ts.col = 3, ic.col = 2, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[31]]$variables$V4$site
FitModel(db = db[[31]], ts.col = 4, ic.col = 3, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[31]]$variables$V5$site
FitModel(db = db[[31]], ts.col = 5, ic.col = 1, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[31]]$variables$V6$site
FitModel(db = db[[31]], ts.col = 6, ic.col = 2, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```

```{r}
db[[31]]$variables$V7$site
FitModel(db = db[[31]], ts.col = 7, ic.col = 3, UnitConverter = 10 , 
         inipars= list(c(0.05, 0.005, 0.1),
                       c(0.01, 0.00001, 0.1, 0.01, 0.01),
                       c(0.01, 0.00001, 0.1, 0.01)))
```